{
  "variables": {
    "esx_build_server": "{{ env `ESX_BUILD_SERVER` }}",
    "esx_build_datastore": "{{ env `ESX_BUILD_DATASTORE` }}",
    "esx_build_network": "{{ env `ESX_BUILD_NETWORK` }}",
    "esx_build_username": "{{ env `ESX_BUILD_USERNAME` }}",
    "esx_build_password": "{{ env `ESX_BUILD_PASSWORD` }}",
    "vm_cpus": "8",
    "vm_memory": "8192",
    "vm_disk_os_size": "102400",
    "vm_disk_data_size": "102400",
    "vm_guest_username": "{{ env `VM_GUEST_USERNAME` }}",
    "vm_guest_password": "{{ env `VM_GUEST_PASSWORD` }}",
    "vm_shutdown_command": "sudo poweroff",
    "vm_disk_adapter_type": "nvme"
  },
  "builders": [{
          "type": "vmware-iso",
          "boot_command": [ 
            "<wait>",
            "set http_ip {{ .HTTPIP }}<enter>",
            "set http_port {{ .HTTPPort }}<enter>",
            "dhcp && chain http://${http_ip}:${http_port}/ubuntu/20.04/20.04.ipxe<enter>"
          ],
          "http_directory": "db/httpdir",
          "iso_url": "https://github.com/tlhakhan/ipxe-iso/releases/download/v1.0/ipxe.iso",
          "iso_checksum":"aed2f5c2a15ebf31a4a2782943bb0cabf59c4f0ccc8c9277822573d7bd6e5adb",
          "vm_name": "{{ user `vm_hostname` }}",
          "ssh_username": "{{ user `vm_guest_username` }}",
          "ssh_password": "{{ user `vm_guest_password` }}",
          "ssh_timeout": "25m",
          "shutdown_command": "{{ user `vm_shutdown_command` }}",
          "remote_type": "esx5",
          "remote_host": "{{ user `esx_build_server` }}",
          "remote_username": "{{ user `esx_build_username` }}",
          "remote_password": "{{ user `esx_build_password` }}",
          "remote_port": "22",
          "remote_datastore": "{{ user `esx_build_datastore` }}",
          "remote_cache_datastore": "{{ user `esx_build_datastore` }}",
          "remote_cache_directory": "packer_cache/{{ user `vm_hostname` }}",
          "guest_os_type": "ubuntu-64",
          "cpus": "{{ user `vm_cpus` }}",
          "memory": "{{ user `vm_memory` }}",
          "version": "15",
          "network_adapter_type": "vmxnet3",
          "vmx_data": {
              "ethernet0.networkName": "{{ user `esx_build_network` }}",
              "numa.autosize.once" : "false",
              "numa.autosize" : "true",
              "mem.hotadd" : "true",
              "vcpu.hotadd" : "true",
              "vmxnet3.rev.30": "false"
          },
          "disk_adapter_type": "{{ user `vm_disk_adapter_type` }}",
          "disk_size": "{{ user `vm_disk_os_size` }}",
          "disk_additional_size": [ "{{ user `vm_disk_data_size` }}" ],
          "keep_registered": "true",
          "skip_export": "true",
          "disk_type_id": "thin",
          "format": "vmx",
	  "vnc_over_websocket": "true",
	  "insecure_connection": "true",
	  "skip_validate_credentials": "true"
    }
  ],
  "provisioners":[
    {
      "type":"shell",
      "environment_vars": [ "VM_HOSTNAME={{ user `vm_hostname` }}" ],
      "script": "db/bootstrap/ubuntu/20.04/bootstrap.sh"
    }
   ]
}
